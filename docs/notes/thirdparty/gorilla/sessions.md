# gorilla/sessions

- [「Go工具箱」web中的session管理，推荐使用gorilla/sessions包](https://cloud.tencent.com/developer/article/2211987)
- [Go 每日一库之 gorilla/sessions](https://darjun.github.io/2021/07/25/godailylib/gorilla/sessions/)
- [Go语言中文文档](https://www.topgoer.com/gin%E6%A1%86%E6%9E%B6/%E4%BC%9A%E8%AF%9D%E6%8E%A7%E5%88%B6/Sessions.html)

几篇教程都讲的session原理还行但实现就很一般了，还是记一下。

## 初始化会话仓库

```go
func sessions.NewFilesystemStore(path string, keyPairs ...[]byte) *sessions.FilesystemStore
```

这里使用的是本地文件存储会话为例，mysql或redis实现可以去查原项目的API。
`path`为存储路径，`keyPairs`为密钥，测试用的话随便设一个就行。

## 新建/获取session

```go
func (s *FilesystemStore) New(r *http.Request, name string) (*Session, error)
func (s *FilesystemStore) Get(r *http.Request, name string) (*Session, error)
```

`Get`方法其实复合了`New`方法，当request中没有对应会话时返回一个新会话。name参数用来区别不同的会话，比如你要管理的是用户状态就可以用user之类。

## 保存session

```go
func (s *FilesystemStore) Save(r *http.Request, w http.ResponseWriter, session *Session) error
```

这个方法同时将会话保存到本地和request。

## 操作session

session的定义如下：

```go
type Session struct {
 // The ID of the session, generated by stores. It should not be used for
 // user data.
 ID string
 // Values contains the user-data for the session.
 Values  map[interface{}]interface{}
 Options *Options
 IsNew   bool
 // contains filtered or unexported fields
}
```

关于`Session.ID`，它说是说会由store自动生成，可是我试了无论是`Store.New()`方法还是`sessions.NewSession()`方法生成的session的ID都是空的。所以还是建议手动赋值一个id，可以使用`jakehl/goid`生成一个uuid。

要为session赋值或者从session中取出值，只需要操作`session.Values`就行，例如：

```go
session, err := Store.New(ctx.Request, "user")
session.Values["userid"]=123  // 赋值
userid = session.Values["userid"]  // 取值
```

## 删除session

将session的过期时间设置为-1即可，store将自动从本地删除session，同时清空request里的session。

```go
session.Options.MaxAge = -1
```
